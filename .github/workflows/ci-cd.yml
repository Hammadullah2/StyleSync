# name: CI/CD Pipeline

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # --- Checkout code ---
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # --- Set up Python environment ---
#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"

#       # --- Install dependencies ---
#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       # --- Run lint/tests (optional) ---
#       - name: Run syntax check
#         run: python -m compileall .

#       # --- Build Docker image ---
#       - name: Build Docker image
#         run: |
#           docker build -t stylesync-app .

#       # --- Login to AWS ECR (optional, if you push images) ---
#       # - name: Configure AWS credentials
#       #   uses: aws-actions/configure-aws-credentials@v4
#       #   with:
#       #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#       #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#       #     aws-region: us-east-1

#       # --- Deploy to EC2 (SSH) ---
#       - name: Deploy to EC2 via SSH
#         uses: appleboy/ssh-action@v1.2.0
#         with:
#           host: ${{ secrets.EC2_PUBLIC_IP }}
#           username: ubuntu
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             cd /home/ubuntu/StyleSync
#             git pull origin main
#             sudo docker compose down
#             sudo docker compose up -d --build

name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}/stylesync-app
  PYTHON_VERSION: "3.10"

jobs:
  # ---------------- LINT ----------------
  lint:
    name: Lint Code (ruff & black)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install ruff black

      - name: Run Ruff linter
        run: ruff check .

      - name: Run Black formatting check
        run: black --check .

  # ---------------- TEST ----------------
  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests with coverage
        run: |
          pytest --cov=. --cov-fail-under=80

  # ---------------- BUILD ----------------
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .

      - name: Push Docker image to GHCR
        run: docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}

  # ---------------- CANARY DEPLOY ----------------
  canary-deploy:
    name: Canary Deployment
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy canary container
        run: |
          docker run -d \
            -e CANARY=true \
            -p 8081:8080 \
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Wait for canary startup
        run: sleep 10

  # # ---------------- ACCEPTANCE TESTS ----------------
  # acceptance-tests:
  #   name: Acceptance Tests on Canary
  #   runs-on: ubuntu-latest
  #   needs: canary-deploy
  #   steps:
  #     - name: Test canary endpoints
  #       run: |
  #         echo "Running golden set acceptance tests..."
  #         urls=(
  #           "http://localhost:8081/api/health"
  #           "http://localhost:8081/api/predict"
  #           "http://localhost:8081/api/status"
  #           "http://localhost:8081/api/version"
  #           "http://localhost:8081/api/config"
  #         )

  #         for url in "${urls[@]}"; do
  #           echo "Checking $url"
  #           code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
  #           if [ "$code" -ne 200 ]; then
  #             echo "Failed: $url returned $code"
  #             exit 1
  #           else
  #             echo "$url OK"
  #           fi
  #         done

  # ---------------- DEPLOY TO EC2 ----------------
  deploy-prod:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: acceptance-tests
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/StyleSync
            git pull origin main
            sudo docker compose down
            sudo docker compose up -d --build
